<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Disk Scanner</title>
    <style>
        body {
            background-color: rgb(42, 43, 71);
            color: rgb(209, 213, 233);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .scanner-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-top: 20px;
        }

        .camera-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #videoElement {
            width: 480px;
            height: 360px;
            border: 2px solid rgb(209, 213, 233);
            border-radius: 8px;
        }

        #processedCanvas {
            width: 80px;
            height: 400px;
            border: 2px solid rgb(209, 213, 233);
            border-radius: 8px;
            background-color: black;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 250px;
        }

        button {
            padding: 12px;
            background-color: rgb(100, 116, 139);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background-color: rgb(71, 85, 105);
        }

        button:disabled {
            background-color: rgb(64, 64, 64);
            cursor: not-allowed;
        }

        .data-display {
            background-color: rgb(30, 30, 50);
            padding: 20px;
            border-radius: 8px;
            max-width: 600px;
            margin-top: 20px;
            width: 100%;
        }

        .bit-stream {
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            margin: 10px 0;
            padding: 15px;
            background-color: rgb(20, 20, 40);
            border-radius: 4px;
            max-height: 120px;
            overflow-y: auto;
            border: 1px solid rgb(100, 100, 100);
        }

        .decoded-text {
            font-size: 16px;
            margin-top: 10px;
            padding: 15px;
            background-color: rgb(50, 70, 90);
            border-radius: 4px;
            min-height: 60px;
            border: 1px solid rgb(100, 100, 100);
        }

        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status.scanning {
            background-color: rgba(34, 197, 94, 0.2);
            border: 1px solid rgb(34, 197, 94);
        }

        .status.error {
            background-color: rgba(239, 68, 68, 0.2);
            border: 1px solid rgb(239, 68, 68);
        }

        .status.ready {
            background-color: rgba(59, 130, 246, 0.2);
            border: 1px solid rgb(59, 130, 246);
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }

        input[type="range"] {
            width: 100%;
        }

        .scan-area-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 6px;
            height: 80%;
            background: rgba(255, 0, 0, 0.6);
            pointer-events: none;
            z-index: 10;
            border-radius: 2px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 10px 0;
            font-size: 12px;
        }

        .stat-item {
            padding: 5px 10px;
            background-color: rgb(60, 60, 80);
            border-radius: 4px;
        }

        .video-container {
            position: relative;
        }

        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 5;
        }

        .crosshair::before,
        .crosshair::after {
            content: '';
            position: absolute;
            background-color: rgba(255, 255, 0, 0.8);
        }

        .crosshair::before {
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            transform: translateY(-50%);
        }

        .crosshair::after {
            top: 0;
            left: 50%;
            width: 2px;
            height: 100%;
            transform: translateX(-50%);
        }
    </style>
</head>

<body>
    <h1>MIDI Disk Scanner</h1>

    <div class="scanner-container">
        <!-- Camera Feed -->
        <div class="camera-container">
            <h3>Camera Feed</h3>
            <div class="video-container">
                <video id="videoElement" autoplay muted playsinline></video>
                <div class="scan-area-overlay"></div>
                <div class="crosshair"></div>
            </div>

            <h4>Processed Scan Data</h4>
            <canvas id="processedCanvas" width="80" height="400"></canvas>
        </div>

        <!-- Controls -->
        <div class="controls">
            <h3>Scanner Controls</h3>
            <button id="startCamera">üìπ Start Camera</button>
            <button id="startScanning" disabled>üîç Start Scanning</button>
            <button id="stopScanning" disabled>‚èπÔ∏è Stop Scanning</button>
            <button id="resetData">üîÑ Reset Data</button>

            <div class="slider-container">
                <label>Brightness Threshold: <span id="thresholdValue">120</span></label>
                <input type="range" id="threshold" min="50" max="200" value="120">
            </div>

            <div class="slider-container">
                <label>Scan Width: <span id="scanWidthValue">6</span>px</label>
                <input type="range" id="scanWidth" min="2" max="12" value="6">
            </div>

            <div class="slider-container">
                <label>Tracks to Scan: <span id="tracksValue">10</span></label>
                <input type="range" id="tracks" min="5" max="20" value="10">
            </div>

            <div class="slider-container">
                <label>Scan Speed: <span id="speedValue">100</span>ms</label>
                <input type="range" id="speed" min="50" max="500" value="100">
            </div>
        </div>
    </div>

    <!-- Data Display -->
    <div class="data-display">
        <h3>Scanned Data Results</h3>
        <div id="status" class="status ready">Ready to scan - Position camera over disk center</div>

        <div class="stats">
            <div class="stat-item">Bits Scanned: <span id="bitCount">0</span></div>
            <div class="stat-item">Chars Decoded: <span id="charCount">0</span></div>
            <div class="stat-item">Scan Rate: <span id="scanRate">0</span>/sec</div>
        </div>

        <div>
            <strong>Raw Bit Stream:</strong>
            <div id="bitStream" class="bit-stream">Scan data will appear here...</div>
        </div>
        <div>
            <strong>Decoded ASCII Text:</strong>
            <div id="decodedText" class="decoded-text">Decoded text will appear here...</div>
        </div>
    </div>

    <script>
        // Scanner variables
        let videoElement = document.getElementById('videoElement');
        let processedCanvas = document.getElementById('processedCanvas');
        let processedCtx = processedCanvas.getContext('2d');
        let isScanning = false;
        let scanningInterval;
        let scannedBits = '';
        let lastScanTime = 0;
        let diskCenter = null;
        let scanCount = 0;
        let lastStatsUpdate = 0;

        // UI elements
        const startCameraBtn = document.getElementById('startCamera');
        const startScanningBtn = document.getElementById('startScanning');
        const stopScanningBtn = document.getElementById('stopScanning');
        const resetDataBtn = document.getElementById('resetData');
        const thresholdSlider = document.getElementById('threshold');
        const scanWidthSlider = document.getElementById('scanWidth');
        const tracksSlider = document.getElementById('tracks');
        const speedSlider = document.getElementById('speed');
        const statusDiv = document.getElementById('status');
        const bitStreamDiv = document.getElementById('bitStream');
        const decodedTextDiv = document.getElementById('decodedText');
        const bitCountSpan = document.getElementById('bitCount');
        const charCountSpan = document.getElementById('charCount');
        const scanRateSpan = document.getElementById('scanRate');

        // Camera functions
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                });
                videoElement.srcObject = stream;
                startCameraBtn.disabled = true;
                startScanningBtn.disabled = false;
                updateStatus('Camera ready - Position over disk center', 'ready');
            } catch (err) {
                updateStatus('Camera access denied: ' + err.message, 'error');
            }
        }

        function detectDiskCenter() {
            if (!videoElement.videoWidth) return null;

            // For now, use center of video - can be enhanced with actual disk detection
            return {
                x: videoElement.videoWidth / 2,
                y: videoElement.videoHeight / 2,
                radius: Math.min(videoElement.videoWidth, videoElement.videoHeight) / 6
            };
        }

        function scanDiskData() {
            if (!videoElement.videoWidth) return;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = videoElement.videoWidth;
            tempCanvas.height = videoElement.videoHeight;

            tempCtx.drawImage(videoElement, 0, 0);

            if (!diskCenter) {
                diskCenter = detectDiskCenter();
            }

            const scanWidth = parseInt(scanWidthSlider.value);
            const threshold = parseInt(thresholdSlider.value);
            const numTracks = parseInt(tracksSlider.value);

            // Extract vertical scan line from center outward
            const scanData = [];
            const startRadius = 30; // Skip center hole
            const maxRadius = diskCenter.radius;

            // Clear processed canvas
            processedCtx.fillStyle = 'rgb(20, 20, 30)';
            processedCtx.fillRect(0, 0, processedCanvas.width, processedCanvas.height);

            for (let i = 0; i < numTracks; i++) {
                const radius = startRadius + (i / (numTracks - 1)) * (maxRadius - startRadius);
                const x = Math.floor(diskCenter.x);
                const y = Math.floor(diskCenter.y - radius);

                if (x >= scanWidth && x < tempCanvas.width - scanWidth &&
                    y >= 2 && y < tempCanvas.height - 2) {

                    let totalBrightness = 0;
                    let sampleCount = 0;

                    // Sample area around the point
                    for (let dx = -scanWidth; dx <= scanWidth; dx++) {
                        for (let dy = -2; dy <= 2; dy++) {
                            const sampleX = x + dx;
                            const sampleY = y + dy;
                            const pixel = tempCtx.getImageData(sampleX, sampleY, 1, 1).data;
                            const brightness = (pixel[0] + pixel[1] + pixel[2]) / 3;
                            totalBrightness += brightness;
                            sampleCount++;
                        }
                    }

                    const avgBrightness = totalBrightness / sampleCount;
                    const bit = avgBrightness > threshold ? '1' : '0';
                    scanData.push(bit);

                    // Draw visualization
                    const visualY = (i / numTracks) * processedCanvas.height;
                    const trackHeight = processedCanvas.height / numTracks;

                    // Draw bit value (white for 1, dark for 0)
                    processedCtx.fillStyle = bit === '1' ? 'white' : 'rgb(40, 40, 40)';
                    processedCtx.fillRect(10, visualY, processedCanvas.width - 20, trackHeight - 1);

                    // Draw brightness level as colored bar
                    const normalizedBrightness = avgBrightness / 255;
                    if (normalizedBrightness > threshold / 255) {
                        processedCtx.fillStyle = `rgb(100, ${Math.floor(normalizedBrightness * 255)}, 100)`;
                    } else {
                        processedCtx.fillStyle = `rgb(${Math.floor(normalizedBrightness * 255)}, 100, 100)`;
                    }
                    const barWidth = normalizedBrightness * 8;
                    processedCtx.fillRect(1, visualY + trackHeight / 2 - 1, barWidth, 2);

                    // Draw track number
                    processedCtx.fillStyle = 'yellow';
                    processedCtx.font = '8px monospace';
                    processedCtx.fillText(i.toString(), processedCanvas.width - 8, visualY + trackHeight / 2 + 2);
                }
            }

            // Add scanned bits with timing control
            const currentTime = Date.now();
            const scanInterval = parseInt(speedSlider.value);

            if (currentTime - lastScanTime > scanInterval) {
                const newBits = scanData.join('');
                scannedBits += newBits;
                lastScanTime = currentTime;
                scanCount++;
                updateDisplay();
                updateStats();
            }
        }

        function updateDisplay() {
            // Show recent bits (last 800 bits)
            const recentBits = scannedBits.slice(-800);
            bitStreamDiv.textContent = recentBits || 'Scanning...';

            // Try to decode as ASCII
            let decodedText = '';
            const bitsForDecoding = scannedBits.slice(-(Math.floor(scannedBits.length / 8) * 8));

            for (let i = 0; i < bitsForDecoding.length - 7; i += 8) {
                const byte = bitsForDecoding.substr(i, 8);
                if (byte.length === 8) {
                    const charCode = parseInt(byte, 2);
                    if (charCode >= 32 && charCode <= 126) { // Printable ASCII
                        decodedText += String.fromCharCode(charCode);
                    } else if (charCode === 0) {
                        decodedText += '‚àÖ'; // Null character
                    } else {
                        decodedText += '?';
                    }
                }
            }
            decodedTextDiv.textContent = decodedText.slice(-100) || 'Waiting for complete bytes...'; // Show last 100 characters

            // Update counters
            bitCountSpan.textContent = scannedBits.length;
            charCountSpan.textContent = Math.floor(scannedBits.length / 8);
        }

        function updateStats() {
            const currentTime = Date.now();
            if (currentTime - lastStatsUpdate > 1000) { // Update every second
                const rate = scanCount;
                scanRateSpan.textContent = rate;
                scanCount = 0;
                lastStatsUpdate = currentTime;
            }
        }

        function startScanning() {
            if (!isScanning) {
                isScanning = true;
                const interval = Math.max(20, parseInt(speedSlider.value) / 5); // Minimum 20ms for smooth animation
                scanningInterval = setInterval(scanDiskData, interval);
                startScanningBtn.disabled = true;
                stopScanningBtn.disabled = false;
                updateStatus('Scanning... Move camera slowly over rotating disk', 'scanning');
            }
        }

        function stopScanning() {
            if (isScanning) {
                isScanning = false;
                clearInterval(scanningInterval);
                startScanningBtn.disabled = false;
                stopScanningBtn.disabled = true;
                updateStatus('Scanning stopped', 'ready');
            }
        }

        function resetData() {
            scannedBits = '';
            bitStreamDiv.textContent = 'Scan data will appear here...';
            decodedTextDiv.textContent = 'Decoded text will appear here...';
            diskCenter = null;
            scanCount = 0;
            bitCountSpan.textContent = '0';
            charCountSpan.textContent = '0';
            scanRateSpan.textContent = '0';
            updateStatus('Data reset - Ready to scan', 'ready');
        }

        function updateStatus(message, className) {
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + className;
        }

        // Event listeners
        startCameraBtn.addEventListener('click', startCamera);
        startScanningBtn.addEventListener('click', startScanning);
        stopScanningBtn.addEventListener('click', stopScanning);
        resetDataBtn.addEventListener('click', resetData);

        thresholdSlider.addEventListener('input', (e) => {
            document.getElementById('thresholdValue').textContent = e.target.value;
        });

        scanWidthSlider.addEventListener('input', (e) => {
            document.getElementById('scanWidthValue').textContent = e.target.value;
        });

        tracksSlider.addEventListener('input', (e) => {
            document.getElementById('tracksValue').textContent = e.target.value;
        });

        speedSlider.addEventListener('input', (e) => {
            document.getElementById('speedValue').textContent = e.target.value;
        });

        // Initialize
        updateStatus('Ready to scan - Click "Start Camera" to begin', 'ready');
    </script>
</body>

</html>