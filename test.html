<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI QRã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°</title>
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://unpkg.com/qrious@4.0.2/dist/qrious.min.js"></script>
    <script src="https://unpkg.com/@tonejs/midi@2.0.28/build/Midi.js"></script>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h2 {
            margin-top: 0;
            color: #333;
        }

        video,
        canvas {
            width: 100%;
            max-width: 400px;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        input[type="file"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            width: 80px;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.playing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .flash-display {
            text-align: center;
            padding: 20px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .qr-canvas {
            border: 2px solid #333;
            max-width: 100%;
        }

        .label {
            font-weight: bold;
            margin-right: 10px;
        }

        .midi-info {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- å—ä¿¡ãƒ»å†ç”Ÿå´ -->
        <div class="panel">
            <h2>ğŸµ MIDIå—ä¿¡ãƒ»å†ç”Ÿ</h2>

            <video id="video" autoplay></video>
            <canvas id="canvas" style="display: none;"></canvas>

            <div class="controls">
                <button id="startBtn">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
                <button id="stopBtn" disabled>åœæ­¢</button>
                <button id="clearBtn">ã‚¯ãƒªã‚¢</button>
                <button id="playBtn" disabled>å†ç”Ÿ</button>
                <button id="stopPlayBtn" disabled>åœæ­¢</button>
            </div>

            <div class="controls">
                <label>
                    <input type="checkbox" id="autoPlay" checked>
                    è‡ªå‹•å†ç”Ÿï¼ˆãƒãƒ£ãƒ³ã‚¯å—ä¿¡æ™‚ï¼‰
                </label>
            </div>

            <div id="receiverStatus" class="status info">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</div>

            <div class="progress-bar">
                <div id="playProgress" class="progress-fill"></div>
            </div>

            <div class="midi-info" id="midiInfo">
                MIDIãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ã‚’å¾…ã£ã¦ã„ã¾ã™...
            </div>
        </div>

        <!-- é€ä¿¡å´ -->
        <div class="panel">
            <h2>ğŸ“¤ MIDIé€ä¿¡</h2>

            <div class="controls">
                <input type="file" id="midiFile" accept=".mid,.midi" />
                <button id="loadMidiBtn">MIDIèª­ã¿è¾¼ã¿</button>
            </div>

            <div class="controls">
                <span class="label">ãƒãƒ£ãƒ³ã‚¯ç§’æ•°:</span>
                <input type="number" id="chunkSeconds" value="2" min="1" max="10">
                <span class="label">é€ä¿¡FPS:</span>
                <input type="number" id="flashFPS" value="10" min="1" max="30">
            </div>

            <div class="controls">
                <button id="generateBtn" disabled>QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ</button>
                <button id="flashBtn" disabled>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é–‹å§‹</button>
                <button id="stopFlashBtn" disabled>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥åœæ­¢</button>
            </div>

            <div id="senderStatus" class="status info">MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

            <div class="flash-display">
                <canvas id="qrCanvas" class="qr-canvas"></canvas>
            </div>

            <div class="controls">
                <span class="label">é€²è¡ŒçŠ¶æ³:</span>
                <span id="progressDisplay">0 / 0</span>
            </div>

            <div class="midi-info" id="senderMidiInfo">
                MIDIãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...
            </div>
        </div>
    </div>

    <script>
        class MIDIQRStreaming {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.getElementById('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.qrCanvas = document.getElementById('qrCanvas');

                // å—ä¿¡å´
                this.isScanning = false;
                this.receivedChunks = [];
                this.midiData = null;
                this.isPlaying = false;
                this.currentPlayTime = 0;
                this.synth = null;

                // é€ä¿¡å´
                this.originalMidi = null;
                this.qrChunks = [];
                this.flashInterval = null;
                this.currentChunkIndex = 0;

                this.initializeElements();
                this.setupEventListeners();
                this.initializeAudio();
            }

            initializeElements() {
                // å—ä¿¡å´
                this.startBtn = document.getElementById('startBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.playBtn = document.getElementById('playBtn');
                this.stopPlayBtn = document.getElementById('stopPlayBtn');
                this.autoPlay = document.getElementById('autoPlay');
                this.receiverStatus = document.getElementById('receiverStatus');
                this.midiInfo = document.getElementById('midiInfo');
                this.playProgress = document.getElementById('playProgress');

                // é€ä¿¡å´
                this.midiFile = document.getElementById('midiFile');
                this.loadMidiBtn = document.getElementById('loadMidiBtn');
                this.chunkSeconds = document.getElementById('chunkSeconds');
                this.flashFPS = document.getElementById('flashFPS');
                this.generateBtn = document.getElementById('generateBtn');
                this.flashBtn = document.getElementById('flashBtn');
                this.stopFlashBtn = document.getElementById('stopFlashBtn');
                this.senderStatus = document.getElementById('senderStatus');
                this.progressDisplay = document.getElementById('progressDisplay');
                this.senderMidiInfo = document.getElementById('senderMidiInfo');
            }

            setupEventListeners() {
                // å—ä¿¡å´
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
                this.clearBtn.addEventListener('click', () => this.clearData());
                this.playBtn.addEventListener('click', () => this.playMidi());
                this.stopPlayBtn.addEventListener('click', () => this.stopMidi());

                // é€ä¿¡å´
                this.loadMidiBtn.addEventListener('click', () => this.loadMidiFile());
                this.generateBtn.addEventListener('click', () => this.generateQRCodes());
                this.flashBtn.addEventListener('click', () => this.startFlashing());
                this.stopFlashBtn.addEventListener('click', () => this.stopFlashing());
            }

            async initializeAudio() {
                await Tone.start();
                this.synth = new Tone.PolySynth().toDestination();
            }

            async startCamera() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: 'environment' }
                    });
                    this.video.srcObject = stream;
                    this.video.addEventListener('loadedmetadata', () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.startScanning();
                    });

                    this.startBtn.disabled = true;
                    this.stopBtn.disabled = false;
                    this.updateReceiverStatus('ã‚«ãƒ¡ãƒ©ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ', 'success');
                } catch (error) {
                    this.updateReceiverStatus('ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }

            stopCamera() {
                this.isScanning = false;
                if (this.video.srcObject) {
                    this.video.srcObject.getTracks().forEach(track => track.stop());
                    this.video.srcObject = null;
                }
                this.startBtn.disabled = false;
                this.stopBtn.disabled = true;
                this.updateReceiverStatus('ã‚«ãƒ¡ãƒ©ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ', 'info');
            }

            startScanning() {
                this.isScanning = true;
                this.scanFrame();
            }

            scanFrame() {
                if (!this.isScanning) return;

                this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    this.processQRCode(code.data);
                }

                requestAnimationFrame(() => this.scanFrame());
            }

            processQRCode(data) {
                try {
                    if (data.startsWith('MIDI:')) {
                        const jsonData = data.substring(5);
                        const chunkData = JSON.parse(jsonData);

                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                        if (this.receivedChunks.some(c => c.index === chunkData.index)) {
                            return;
                        }

                        this.receivedChunks.push(chunkData);
                        this.receivedChunks.sort((a, b) => a.index - b.index);

                        this.updateReceiverStatus(
                            `ãƒãƒ£ãƒ³ã‚¯ ${chunkData.index + 1} ã‚’å—ä¿¡ã—ã¾ã—ãŸï¼ˆ${this.receivedChunks.length} å€‹ï¼‰`,
                            'success'
                        );

                        this.updateMidiInfo();
                        this.tryPlayNextChunk();
                    }
                } catch (error) {
                    console.error('QRã‚³ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                }
            }

            updateMidiInfo() {
                if (this.receivedChunks.length === 0) return;

                const info = `å—ä¿¡ãƒãƒ£ãƒ³ã‚¯: ${this.receivedChunks.length} å€‹\n`;
                let details = '';

                this.receivedChunks.forEach(chunk => {
                    details += `ãƒãƒ£ãƒ³ã‚¯ ${chunk.index}: ${chunk.notes.length} éŸ³ç¬¦\n`;
                });

                this.midiInfo.textContent = info + details;
            }

            async tryPlayNextChunk() {
                if (this.receivedChunks.length === 0) return;

                // ã©ã®ãƒãƒ£ãƒ³ã‚¯ã§ã‚‚å—ä¿¡ã—ãŸã‚‰å†ç”Ÿé–‹å§‹å¯èƒ½
                if (!this.isPlaying) {
                    this.playBtn.disabled = false;

                    // è‡ªå‹•å†ç”Ÿè¨­å®šãŒã‚ã‚Œã°å³åº§ã«é–‹å§‹
                    if (this.autoPlay.checked && this.receivedChunks.length === 1) {
                        await this.playMidi();
                    }
                }
            }

            async playMidi() {
                if (this.receivedChunks.length === 0) return;

                this.isPlaying = true;
                this.playBtn.disabled = true;
                this.stopPlayBtn.disabled = false;
                this.updateReceiverStatus('MIDIå†ç”Ÿä¸­...', 'playing');

                this.currentPlayTime = 0;
                this.playReceivedChunks();
            }

            async playReceivedChunks() {
                // å—ä¿¡æ¸ˆã¿ã®ãƒãƒ£ãƒ³ã‚¯ã‹ã‚‰é€£ç¶šã™ã‚‹éƒ¨åˆ†ã‚’è¦‹ã¤ã‘ã¦å†ç”Ÿ
                const sortedChunks = this.receivedChunks.sort((a, b) => a.index - b.index);

                for (let i = 0; i < sortedChunks.length && this.isPlaying; i++) {
                    const chunk = sortedChunks[i];

                    this.updateProgress(i, sortedChunks.length);
                    this.updateReceiverStatus(
                        `ãƒãƒ£ãƒ³ã‚¯ ${chunk.index + 1} ã‚’å†ç”Ÿä¸­... (${i + 1}/${sortedChunks.length})`,
                        'playing'
                    );

                    // ä¸¦è¡Œã—ã¦éŸ³ç¬¦ã‚’å†ç”Ÿ
                    const notePromises = chunk.notes.map(note => {
                        return new Promise(resolve => {
                            setTimeout(() => {
                                if (this.isPlaying) {
                                    this.synth.triggerAttackRelease(
                                        note.pitch,
                                        note.duration
                                    );
                                }
                                resolve();
                            }, note.time * 1000);
                        });
                    });

                    // ã“ã®ãƒãƒ£ãƒ³ã‚¯ã®å…¨éŸ³ç¬¦ã®å†ç”Ÿé–‹å§‹ã‚’å¾…ã¤
                    await Promise.all(notePromises);

                    // ãƒãƒ£ãƒ³ã‚¯ã®å†ç”Ÿæ™‚é–“åˆ†å¾…æ©Ÿ
                    await new Promise(resolve => setTimeout(resolve, chunk.duration * 1000));

                    // æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ãŒå—ä¿¡æ¸ˆã¿ã§ãªã„å ´åˆã¯å¾…æ©Ÿ
                    if (i + 1 < sortedChunks.length) {
                        const nextChunkIndex = sortedChunks[i].index + 1;
                        const nextChunk = sortedChunks.find(c => c.index === nextChunkIndex);

                        if (!nextChunk) {
                            // æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã‚’å¾…æ©Ÿ
                            this.updateReceiverStatus(
                                `æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ (${nextChunkIndex + 1}) ã‚’å¾…æ©Ÿä¸­...`,
                                'info'
                            );

                            // æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ãŒæ¥ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§10ç§’ï¼‰
                            let waitTime = 0;
                            while (waitTime < 10000 && this.isPlaying) {
                                await new Promise(resolve => setTimeout(resolve, 100));
                                waitTime += 100;

                                // æ–°ã—ã„ãƒãƒ£ãƒ³ã‚¯ãŒå—ä¿¡ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
                                const updatedChunk = this.receivedChunks.find(c => c.index === nextChunkIndex);
                                if (updatedChunk) {
                                    sortedChunks.splice(i + 1, 0, updatedChunk);
                                    break;
                                }
                            }
                        }
                    }
                }

                if (this.isPlaying) {
                    this.stopMidi();
                    this.updateReceiverStatus('å†ç”Ÿå®Œäº†', 'success');
                }
            }

            stopMidi() {
                this.isPlaying = false;
                this.playBtn.disabled = false;
                this.stopPlayBtn.disabled = true;
                this.synth.releaseAll();
                this.updateProgress(0, 1);
            }

            updateProgress(current, total) {
                const percent = total > 0 ? (current / total) * 100 : 0;
                this.playProgress.style.width = `${percent}%`;
            }

            clearData() {
                this.receivedChunks = [];
                this.stopMidi();
                this.midiInfo.textContent = 'MIDIãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ã‚’å¾…ã£ã¦ã„ã¾ã™...';
                this.updateReceiverStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
            }

            updateReceiverStatus(message, type) {
                this.receiverStatus.textContent = message;
                this.receiverStatus.className = `status ${type}`;
            }

            // é€ä¿¡å´ãƒ¡ã‚½ãƒƒãƒ‰
            async loadMidiFile() {
                const file = this.midiFile.files[0];
                if (!file) {
                    this.updateSenderStatus('MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                    return;
                }

                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.originalMidi = new Midi(arrayBuffer);

                    this.displayMidiInfo();
                    this.generateBtn.disabled = false;
                    this.updateSenderStatus('MIDIãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                } catch (error) {
                    this.updateSenderStatus('MIDIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }

            displayMidiInfo() {
                if (!this.originalMidi) return;

                const info = `
ãƒ•ã‚¡ã‚¤ãƒ«å: ${this.midiFile.files[0].name}
ãƒˆãƒ©ãƒƒã‚¯æ•°: ${this.originalMidi.tracks.length}
æ¼”å¥æ™‚é–“: ${this.originalMidi.duration.toFixed(2)} ç§’
éŸ³ç¬¦æ•°: ${this.originalMidi.tracks.reduce((sum, track) => sum + track.notes.length, 0)}
                `.trim();

                this.senderMidiInfo.textContent = info;
            }

            generateQRCodes() {
                if (!this.originalMidi) return;

                const chunkDuration = parseFloat(this.chunkSeconds.value);
                this.qrChunks = [];

                // MIDIãƒ‡ãƒ¼ã‚¿ã‚’æ™‚é–“ãƒ™ãƒ¼ã‚¹ã§ãƒãƒ£ãƒ³ã‚¯ã«åˆ†å‰²
                const chunks = this.splitMidiByTime(this.originalMidi, chunkDuration);

                chunks.forEach((chunk, index) => {
                    const chunkData = {
                        index: index,
                        total: chunks.length,
                        duration: chunkDuration,
                        notes: chunk
                    };

                    const qrData = 'MIDI:' + JSON.stringify(chunkData);
                    this.qrChunks.push(qrData);
                });

                this.currentChunkIndex = 0;
                this.flashBtn.disabled = false;
                this.updateSenderStatus(`${this.qrChunks.length} å€‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸ`, 'success');
                this.updateProgress();

                // æœ€åˆã®QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
                this.displayQRCode(this.qrChunks[0]);
            }

            splitMidiByTime(midi, chunkDuration) {
                const chunks = [];
                let currentTime = 0;

                while (currentTime < midi.duration) {
                    const endTime = currentTime + chunkDuration;
                    const chunkNotes = [];

                    midi.tracks.forEach(track => {
                        track.notes.forEach(note => {
                            if (note.time >= currentTime && note.time < endTime) {
                                chunkNotes.push({
                                    pitch: note.name,
                                    time: note.time - currentTime,
                                    duration: note.duration,
                                    velocity: note.velocity
                                });
                            }
                        });
                    });

                    if (chunkNotes.length > 0) {
                        chunks.push(chunkNotes);
                    }

                    currentTime = endTime;
                }

                return chunks;
            }

            displayQRCode(data) {
                try {
                    const qr = new QRious({
                        element: this.qrCanvas,
                        value: data,
                        size: 300,
                        background: 'white',
                        foreground: 'black',
                        level: 'L'
                    });
                } catch (error) {
                    this.updateSenderStatus('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
                }
            }

            startFlashing() {
                if (this.qrChunks.length === 0) return;

                const fps = parseInt(this.flashFPS.value);
                const interval = 1000 / fps;

                this.flashInterval = setInterval(() => {
                    this.displayQRCode(this.qrChunks[this.currentChunkIndex]);
                    this.currentChunkIndex = (this.currentChunkIndex + 1) % this.qrChunks.length;
                    this.updateProgressDisplay();
                }, interval);

                this.flashBtn.disabled = true;
                this.stopFlashBtn.disabled = false;
                this.updateSenderStatus(`${fps} FPS ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é€ä¿¡ä¸­...`, 'success');
            }

            stopFlashing() {
                if (this.flashInterval) {
                    clearInterval(this.flashInterval);
                    this.flashInterval = null;
                }
                this.flashBtn.disabled = false;
                this.stopFlashBtn.disabled = true;
                this.updateSenderStatus('ãƒ•ãƒ©ãƒƒã‚·ãƒ¥é€ä¿¡ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'info');
            }

            updateProgressDisplay() {
                this.progressDisplay.textContent = `${this.currentChunkIndex + 1} / ${this.qrChunks.length}`;
            }

            updateSenderStatus(message, type) {
                this.senderStatus.textContent = message;
                this.senderStatus.className = `status ${type}`;
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new MIDIQRStreaming();
        });
    </script>
</body>

</html>